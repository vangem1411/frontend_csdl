<template>
  <div class="page-top-banner">
    <h2>Cảnh báo lỗ hổng trang web</h2>
  </div>

  <div class="container py-3">
    <!-- Header -->
    <div class="page-head compact">
      <div class="d-flex align-items-center gap-2">
        <small class="text-muted me-2 d-none d-md-inline">
          Lọc tại chỗ • Tổng: {{ total.toLocaleString('vi-VN') }}
        </small>
        <button class="btn btn-light refresh-btn" :disabled="isLoading" @click="refresh" type="button">
          <i class="fa-solid fa-rotate"></i> <span class="d-none d-sm-inline">Làm mới</span>
        </button>
      </div>
    </div>

    <!-- ===== Toolbar kiểu "Quản lý địa bàn" ===== -->
    <div class="x_content position-relative">
      <div v-if="isLoading" class="dt-processing-overlay">
        <div class="dt-processing-box">Đang xử lý...</div>
      </div>

      <!-- Hàng 1: Xem / Export / Tìm (giống địa bàn) -->
      <div class="row mb-3" v-if="!isLoading">
        <!-- Trái: Xem {perPage} mục -->
        <div class="col-md-3 d-flex align-items-center">
          <label class="me-2 mb-0">Xem</label>
          <select class="form-control d-inline-block w-auto" v-model.number="pageSize">
            <option :value="10">10</option>
            <option :value="20">20</option>
            <option :value="50">50</option>
            <option :value="100">100</option>
          </select>
          <span class="ms-2">mục</span>
        </div>

        <!-- Giữa: Export -->
        <div class="col-md-6 text-center">
          <div class="btn-group">
            <button class="btn btn-sm btn-secondary" @click="exportCopy" type="button">Copy</button>
            <button class="btn btn-sm btn-success"   @click="exportExcel" type="button">Excel</button>
            <button class="btn btn-sm btn-info"      @click="exportCSV" type="button">CSV</button>
            <button class="btn btn-sm btn-danger"    @click="exportPDF" type="button">PDF</button>
            <button class="btn btn-sm btn-dark"      @click="window.print()" type="button">Print</button>
          </div>
        </div>

        <!-- Phải: Tìm -->
        <div class="col-md-3">
          <div class="input-group">
            <input
              v-model.trim="searchTerm"
              @keyup.enter="applySearch"
              type="text"
              class="form-control"
              placeholder="Tìm"
            />
            <button class="btn btn-secondary" @click="applySearch" type="button">Tìm</button>
          </div>
        </div>
      </div>

      <!-- Hàng 2: Chips + dropdown trạng thái (tách riêng) -->
      <div class="d-flex align-items-center flex-wrap gap-2 mb-2" v-if="!isLoading">
        <div class="btn-group filter-chips me-2" role="group">
          <button
            v-for="opt in statusChips"
            :key="opt.value"
            class="btn btn-chip"
            :class="{ active: statusFilter === opt.value }"
            @click="toggleStatus(opt.value)"
            type="button"
          >
            <span class="dot" :style="{ background: opt.color }"></span>{{ opt.label }}
          </button>
        </div>
        <select class="form-select form-select-sm shadow-none w-auto" v-model="statusFilter" @change="resetToFirstPage">
          <option value="">Tất cả trạng thái</option>
          <option v-for="opt in statusOptions" :key="opt.value" :value="opt.value">{{ opt.label }}</option>
        </select>
      </div>

      <!-- ===== Bảng (giống địa bàn) ===== -->
      <div class="table-responsive">
        <table class="table table-striped table-bordered" style="width:100%">
          <thead>
            <tr>
              <th style="width:70px">STT</th>
              <th>Tên website</th>
              <th>CVE / Vấn đề</th>
              <th style="width:160px">Trạng thái</th>
              <th style="width:180px">Ngày tạo</th>
              <th style="width:200px">Hành động</th>
            </tr>
          </thead>

          <tbody v-if="!isLoading && pagedRows.length === 0">
            <tr>
              <td colspan="6" class="text-center text-muted py-5">Không có dữ liệu phù hợp.</td>
            </tr>
          </tbody>

          <tbody v-else>
            <tr v-for="(row, i) in pagedRows" :key="row.id">
              <td class="text-muted">{{ startIndex + i + 1 }}</td>

              <td>
                <div class="fw-semibold">{{ getWebsiteName(row) || ('Website #' + (row.website_id ?? '—')) }}</div>
                <div class="text-muted small text-truncate" v-if="row.website?.url">{{ row.website.url }}</div>
              </td>

              <td>
                {{ getVulnLabel(row) || ('Vuln #' + (row.common_vulnerabilitie_id ?? row.vulnerability_id ?? '—')) }}
              </td>

              <td>
                <span :class="['badge', badgeClass(row.status)]">{{ statusLabel(row.status) }}</span>
              </td>

              <td class="text-muted">{{ formatDate(row.created_at) }}</td>
                   <td>
                <div class="btn-group" role="group">
                  <button class="btn btn-info btn-sm" @click="openView(row)" title="Xem" type="button">
                    <i class="fa fa-eye"></i>
                  </button>
                  <button class="btn btn-warning btn-sm" @click="openEdit(row)" title="Sửa" type="button">
                    <i class="fa fa-pencil"></i>
                  </button>
                  <button class="btn btn-danger btn-sm" @click="onAskDelete(row)" title="Xóa" type="button">
                    <i class="fa fa-trash"></i>
                  </button>
                </div>
              </td>
            </tr>
          </tbody>
        </table>
      </div>

      <!-- Phân trang giống trang địa bàn -->
      <nav v-if="totalPages > 1 && !isLoading" aria-label="Vuln pagination">
        <ul class="pagination justify-content-end flex-wrap">
          <li class="page-item" :class="{ disabled: page === 1 }">
            <button class="page-link" @click="goFirst" :disabled="page === 1" type="button">«</button>
          </li>
          <li class="page-item" :class="{ disabled: page === 1 }">
            <button class="page-link" @click="prevPage" :disabled="page === 1" type="button">‹</button>
          </li>
          <li
            class="page-item"
            v-for="p in pageWindow"
            :key="p.key"
            :class="{ active: p.num === page, disabled: p.ellipsis }"
          >
            <button class="page-link" v-if="!p.ellipsis" @click="goPage(p.num)" type="button">{{ p.num }}</button>
            <span class="page-link" v-else>…</span>
          </li>
          <li class="page-item" :class="{ disabled: page === totalPages }">
            <button class="page-link" @click="nextPage" :disabled="page === totalPages" type="button">›</button>
          </li>
          <li class="page-item" :class="{ disabled: page === totalPages }">
            <button class="page-link" @click="goLast" :disabled="page === totalPages" type="button">»</button>
          </li>
        </ul>
      </nav>
    </div>
  </div>

  <!-- ===== Modals giữ nguyên ===== -->
  <!-- View -->
  <div v-if="showView" class="x-modal" @keydown.esc="closeView" tabindex="-1">
    <div class="x-modal__backdrop" @click="closeView"></div>
    <div class="x-modal__dialog">
      <div class="x-modal__header x-modal__header--primary">
        <h5>Chi tiết lỗ hổng bảo mật</h5>
        <button class="btn-close btn-close-white" @click="closeView" type="button" aria-label="Close"></button>
      </div>
      <div class="x-modal__body">
        <div v-if="viewLoading" class="text-center text-muted py-3">
          <div class="spinner-border spinner-border-sm me-2"></div> Đang tải chi tiết...
        </div>

        <template v-else-if="current">
          <h6 class="section-title">Thông tin website</h6>
          <table class="table table-bordered table-detail mb-3">
            <tbody>
              <tr><th>Tên website</th><td>{{ websiteDetail?.name || getWebsiteName(current) || ('#' + current.website_id) }}</td></tr>
              <tr><th>URL</th><td>{{ websiteDetail?.url || current.website?.url || '—' }}</td></tr>
              <tr><th>Mô tả</th><td><div class="prewrap">{{ websiteDetail?.description || '—' }}</div></td></tr>
            </tbody>
          </table>

          <h6 class="section-title mt-3">Thông tin lỗ hổng</h6>
          <table class="table table-bordered table-detail">
            <tbody>
              <tr><th>CVE ID</th><td>{{ vulnDetail?.cve_id || getVulnLabel(current) || '—' }}</td></tr>
              <tr><th>Tiêu đề</th><td>{{ vulnDetail?.title || '—' }}</td></tr>
              <tr><th>Mức độ</th><td>{{ vulnDetail?.severity || '—' }}</td></tr>
              <tr><th>Điểm CVSS</th><td>{{ vulnDetail?.cvss_score || '—' }}</td></tr>
              <tr><th>Mô tả</th><td><div class="prewrap">{{ vulnDetail?.description || '—' }}</div></td></tr>
              <tr><th>Trạng thái</th><td>{{ vulnDetail?.status || '—' }}</td></tr>
            </tbody>
          </table>
        </template>

        <div v-else class="text-muted">Không có dữ liệu.</div>
      </div>
      <div class="x-modal__footer">
        <button class="btn btn-light" @click="closeView" type="button">Đóng</button>
      </div>
    </div>
  </div>

  <!-- Edit -->
  <div v-if="showEdit" class="x-modal" @keydown.esc="closeEdit" tabindex="-1">
    <div class="x-modal__backdrop" @click="closeEdit"></div>
    <div class="x-modal__dialog">
      <div class="x-modal__header x-modal__header--warning">
        <h5>Cập nhật cảnh báo</h5>
        <button class="btn-close btn-close-white" @click="closeEdit" type="button" aria-label="Close"></button>
      </div>
      <div class="x-modal__body">
        <div v-if="editForm">
          <div class="mb-3">
            <label class="form-label">Trạng thái</label>
            <select class="form-select" v-model="editForm.status">
              <option v-for="opt in statusOptions" :key="opt.value" :value="opt.value">{{ opt.label }}</option>
            </select>
          </div>
          <div class="mb-3">
            <label class="form-label">Ghi chú</label>
            <textarea class="form-control" rows="3" v-model.trim="editForm.note" placeholder="Nhập ghi chú..."></textarea>
          </div>
        </div>
        <div v-else class="text-muted">Không có dữ liệu.</div>
      </div>
      <div class="x-modal__footer">
        <button class="btn btn-secondary" @click="closeEdit" type="button">Hủy</button>
        <button class="btn btn-primary" :disabled="saving" @click="saveEdit" type="button">
          <span v-if="saving" class="spinner-border spinner-border-sm me-2"></span>
          Cập nhật
        </button>
      </div>
    </div>
  </div>

  <!-- Confirm Delete -->
  <div v-if="showDeleteConfirm" class="x-modal" @keydown.esc="cancelDelete" tabindex="-1">
    <div class="x-modal__backdrop" @click="cancelDelete"></div>
    <div class="x-modal__dialog x-modal__dialog--danger">
      <div class="x-modal__header x-modal__header--danger">
        <h5><i class="fa fa-triangle-exclamation me-2"></i>Xác nhận xóa</h5>
        <button class="btn-close btn-close-white" @click="cancelDelete" type="button" aria-label="Close"></button>
      </div>
      <div class="x-modal__body">
        <p class="mb-2">Bạn chắc chắn muốn xóa <b>cảnh báo #{{ deleteTarget?.id }}</b>?</p>
        <ul class="list-unstyled mb-0 small text-muted">
          <li><b>Website:</b> {{ deleteTarget ? (getWebsiteName(deleteTarget) || ('#' + deleteTarget.website_id)) : '—' }}</li>
          <li><b>Vấn đề:</b> {{ deleteTarget ? (getVulnLabel(deleteTarget) || ('#' + (deleteTarget.common_vulnerabilitie_id ?? deleteTarget.vulnerability_id ?? '—'))) : '—' }}</li>
        </ul>
        <div class="alert alert-warning mt-3 mb-0">
          <i class="fa fa-exclamation-circle me-2"></i>Hành động này không thể hoàn tác.
        </div>
      </div>
      <div class="x-modal__footer">
        <button class="btn btn-outline-secondary" @click="cancelDelete" :disabled="deleteLoading" type="button">Hủy</button>
        <button class="btn btn-danger" @click="confirmDelete" :disabled="deleteLoading" type="button">
          <span v-if="deleteLoading" class="spinner-border spinner-border-sm me-2"></span>
          Xóa
        </button>
      </div>
    </div>
  </div>
</template>

<script setup>
import { ref, computed, onMounted, watch } from 'vue'
import { useToast } from 'vue-toastification'

const toast = useToast()

const API_ALERTS = '/api/website-vulnerability'
const API_WEBSITE = '/api/website'
const API_VULN    = '/api/vulnerability'

const isLoading = ref(false)
const saving = ref(false)
const rawRows = ref([])
const total = ref(0)

const searchTerm = ref('')
const statusFilter = ref('')

const current = ref(null)
const editForm = ref(null)

const showView = ref(false)
const showEdit = ref(false)

const showDeleteConfirm = ref(false)
const deleteTarget = ref(null)
const deleteLoading = ref(false)

const viewLoading = ref(false)
const websiteDetail = ref(null)
const vulnDetail = ref(null)

const websiteNameMap = ref(new Map())
const vulnLabelMap   = ref(new Map())

const statusChips = [
  { value: '', label: 'Tất cả', color: '#94a3b8' },
  { value: 'new', label: 'Mới', color: '#a78bfa' },
  { value: 'investigating', label: 'Đang điều tra', color: '#f59e0b' },
  { value: 'confirmed', label: 'Đã xác nhận', color: '#60a5fa' },
  { value: 'resolved', label: 'Đã xử lý', color: '#10b981' },
]
const statusOptions = [
  { value: 'new', label: 'Mới' },
  { value: 'investigating', label: 'Đang điều tra' },
  { value: 'confirmed', label: 'Đã xác nhận' },
  { value: 'resolved', label: 'Đã xử lý' },
]

function headers() {
  const h = { Accept: 'application/json' }
  const token = localStorage.getItem('token')
  if (token) h['Authorization'] = 'Bearer ' + token
  return h
}
async function fetchJson(url, opts = {}) {
  const res = await fetch(url, { headers: headers(), credentials: 'include', ...opts })
  if (!res.ok) throw new Error(`${res.status} ${res.statusText}`)
  return res.json()
}

const bestWebsiteLabel = (w) => w?.name || null
const bestVulnLabel    = (v) => v?.cve_id || v?.title || null

function getWebsiteName(row){
  if (row.website?.name) return row.website.name
  const id = Number(row.website_id)
  if (id && websiteNameMap.value.has(id)) return websiteNameMap.value.get(id)
  return null
}
function getVulnLabel(row){
  const id = Number(row.common_vulnerabilitie_id ?? row.vulnerability_id)
  if (row.vulnerability?.cve_id || row.vulnerability?.title) return bestVulnLabel(row.vulnerability)
  if (id && vulnLabelMap.value.has(id)) return vulnLabelMap.value.get(id)
  return null
}
function statusLabel(s){
  return ({new:'Mới',investigating:'Đang điều tra',confirmed:'Đã xác nhận',resolved:'Đã xử lý'})[s] || s || '—'
}
function badgeClass(s){
  if (s==='new') return 'badge-soft-violet'
  if (s==='confirmed') return 'badge-soft-blue'
  if (s==='investigating') return 'badge-soft-amber'
  if (s==='resolved') return 'badge-soft-green'
  return 'badge-soft-muted'
}
function formatDate(iso){
  if (!iso) return '—'
  try{ const d=new Date(iso); return d.toLocaleTimeString('vi-VN')+' '+d.toLocaleDateString('vi-VN') }catch{ return iso }
}

/* Load & Preload */
async function preloadDictionaries(){
  try{
    const p = new URLSearchParams({ draw:'1', start:'0', length:'10000' })
    const webJson = await fetchJson(`${API_WEBSITE}?${p}`).catch(() => null)
    const webs = Array.isArray(webJson?.data) ? webJson.data : (Array.isArray(webJson) ? webJson : [])
    for (const w of webs){
      const id = Number(w?.id); if (!id) continue
      const label = bestWebsiteLabel(w)
      if (label) websiteNameMap.value.set(id, label)
    }
    const vulJson = await fetchJson(`${API_VULN}?${p}`).catch(() => null)
    const vulns = Array.isArray(vulJson?.data) ? vulJson.data : (Array.isArray(vulJson) ? vulJson : [])
    for (const v of vulns){
      const id = Number(v?.id); if (!id) continue
      const label = bestVulnLabel(v)
      if (label) vulnLabelMap.value.set(id, label)
    }
  }catch{}
}
async function loadAlerts(){
  const params = new URLSearchParams({ draw:'1', start:'0', length:'10000' })
  const json = await fetchJson(`${API_ALERTS}?${params}`)
  const rows = Array.isArray(json?.data) ? json.data : (Array.isArray(json) ? json : [])
  rawRows.value = rows
  total.value = Number(json?.recordsTotal || rows.length || 0)
}
async function refresh(){
  isLoading.value = true
  try{
    await preloadDictionaries()
    await loadAlerts()
  }finally{
    isLoading.value = false
  }
}

/* Search & Filter */
const normalizedSearch = computed(() => searchTerm.value.trim().toLowerCase())
const filteredRows = computed(() => {
  let arr = rawRows.value
  if (statusFilter.value){
    arr = arr.filter(r => (r.status||'').toLowerCase() === statusFilter.value)
  }
  if (normalizedSearch.value){
    const q = normalizedSearch.value
    arr = arr.filter(r => {
      const website = (getWebsiteName(r)||'').toLowerCase()
      const vuln = (getVulnLabel(r)||'').toLowerCase()
      const idStr = String(r.id||'')
      const wIdStr = String(r.website_id||'')
      const vIdStr = String(r.common_vulnerabilitie_id || r.vulnerability_id || '')
      return website.includes(q) || vuln.includes(q) || idStr.includes(q) || wIdStr.includes(q) || vIdStr.includes(q)
    })
  }
  return arr
})
function applySearch(){ resetToFirstPage() }
function toggleStatus(v){ statusFilter.value = v; resetToFirstPage() }
function resetToFirstPage(){ page.value = 1 }

/* Pagination */
const page = ref(1)
const pageSize = ref(10)

const totalPages = computed(() => Math.max(1, Math.ceil(filteredRows.value.length / pageSize.value)))
const startIndex = computed(() => (page.value - 1) * pageSize.value)
const endIndex = computed(() => Math.min(filteredRows.value.length, startIndex.value + pageSize.value))
const pagedRows = computed(() => filteredRows.value.slice(startIndex.value, endIndex.value))

watch([filteredRows, pageSize], () => {
  if (page.value > totalPages.value) page.value = totalPages.value
})

function prevPage(){ if (page.value > 1) page.value-- }
function nextPage(){ if (page.value < totalPages.value) page.value++ }
function goFirst(){ page.value = 1 }
function goLast(){ page.value = totalPages.value }
function goPage(p){ if (p>=1 && p<=totalPages.value) page.value = p }

const pageWindow = computed(() => {
  const cur = page.value, last = totalPages.value, win = 2, out=[]
  const push = n => out.push({ key:'p'+n, num:n }), sep = k => out.push({ key:k, ellipsis:true })
  if (last <= 7) { for (let i=1;i<=last;i++) push(i); return out }
  push(1); if (cur > 3 + win) sep('a')
  for (let i=Math.max(2, cur-win); i<=Math.min(last-1, cur+win); i++) push(i)
  if (cur < last - (2+win)) sep('b'); push(last); return out
})

/* Export toàn bộ kết quả đã lọc */
const exportHeaders = ['STT','Tên website','CVE / Vấn đề','Trạng thái','Ngày tạo']
const exportRows = () => filteredRows.value.map((r, i) => [
  i + 1,
  getWebsiteName(r) || ('Website #' + (r.website_id ?? '—')),
  getVulnLabel(r) || ('Vuln #' + (r.common_vulnerabilitie_id ?? r.vulnerability_id ?? '—')),
  statusLabel(r.status),
  formatDate(r.created_at)
])
const exportCopy = () => {
  const lines = [exportHeaders.join('\t'), ...exportRows().map(r=>r.join('\t'))].join('\n')
  navigator.clipboard.writeText(lines); toast.success('Đã copy vào clipboard!')
}
const exportCSV = () => {
  const toCsv = (a)=>a.map(r=>r.map(v=>`"${String(v).replaceAll('"','""')}"`).join(',')).join('\n')
  const csv = toCsv([exportHeaders, ...exportRows()])
  const blob = new Blob([csv], {type:'text/csv;charset=utf-8;'})
  const a = document.createElement('a')
  a.href = URL.createObjectURL(blob)
  a.download = 'alerts_filtered_all.csv'
  a.click()
  URL.revokeObjectURL(a.href)
}
const exportExcel = () => exportCSV()
const exportPDF = () => window.print()

/* Modals */
async function openView(row){
  current.value = row
  websiteDetail.value = null
  vulnDetail.value = null
  showView.value = true
  viewLoading.value = true
  try{
    websiteDetail.value = await fetchWebsiteDetail(row.website_id, row.website)
    vulnDetail.value    = await fetchVulnDetail(row.common_vulnerabilitie_id ?? row.vulnerability_id, row.vulnerability)
  }catch{} finally{ viewLoading.value = false }
}
function closeView(){ showView.value = false }

async function openEdit(row){
  current.value = row
  editForm.value = { id:row.id, status:row.status||'', note:row.note||'' }
  showEdit.value = true
}
function closeEdit(){ showEdit.value = false }

/* fetch chi tiết */
async function fetchWebsiteDetail(id, embedded){
  const base = {
    id: embedded?.id ?? id,
    name: embedded?.name ?? getWebsiteName({ website: embedded, website_id: id }),
    url: embedded?.url ?? '',
    description: embedded?.description ?? ''
  }
  if (!id) return base
  try{
    const data = await fetchJson(`${API_WEBSITE}/${Number(id)}`)
    return {
      id: data?.id ?? base.id,
      name: data?.name ?? base.name,
      url: data?.url ?? base.url,
      description: data?.description ?? base.description,
    }
  }catch{ return base }
}
async function fetchVulnDetail(id, embedded){
  const base = {
    id: embedded?.id ?? id,
    cve_id: embedded?.cve_id ?? embedded?.title ?? '',
    title: embedded?.title ?? '',
    severity: embedded?.severity ?? '',
    cvss_score: embedded?.cvss_score ?? '',
    description: embedded?.description ?? '',
    status: embedded?.status ?? ''
  }
  if (!id) return base
  try{
    const data = await fetchJson(`${API_VULN}/${Number(id)}`)
    return {
      id: data?.id ?? base.id,
      cve_id: data?.cve_id ?? base.cve_id,
      title: data?.title ?? base.title,
      severity: data?.severity ?? base.severity,
      cvss_score: data?.cvss_score ?? base.cvss_score,
      description: data?.description ?? base.description,
      status: data?.status ?? base.status,
    }
  }catch{ return base }
}

/* Save */
async function saveEdit(){
  if (!editForm.value) return
  const payload = { status: editForm.value.status, note: editForm.value.note }
  saving.value = true
  try{
    await fetchJson(`${API_ALERTS}/${editForm.value.id}`, {
      method:'PUT',
      body: JSON.stringify(payload),
      headers: { ...headers(), 'Content-Type':'application/json' },
    })
    const idx = rawRows.value.findIndex(r => r.id === editForm.value.id)
    if (idx>=0) rawRows.value[idx] = { ...rawRows.value[idx], ...payload }
    closeEdit()
    toast.success('Cập nhật cảnh báo thành công!')
  }catch(e){
    toast.error('Cập nhật thất bại: ' + (e?.message || e))
  }finally{
    saving.value = false
  }
}

/* Delete */
function onAskDelete(row){
  deleteTarget.value = row
  showDeleteConfirm.value = true
}
function cancelDelete(){
  if (deleteLoading.value) return
  showDeleteConfirm.value = false
  deleteTarget.value = null
}
async function confirmDelete(){
  if (!deleteTarget.value?.id) return
  deleteLoading.value = true
  try{
    await fetchJson(`${API_ALERTS}/${deleteTarget.value.id}`, { method:'DELETE', headers:{ ...headers() } })
    rawRows.value = rawRows.value.filter(r => r.id !== deleteTarget.value.id)
    toast.warning(`Đã xóa cảnh báo #${deleteTarget.value.id}`)
    cancelDelete()
  }catch(e){
    toast.error('Xóa thất bại: ' + (e?.message || e))
  }finally{
    deleteLoading.value = false
  }
}

onMounted(refresh)
</script>

<style scoped>
.page-head{display:flex;align-items:center;justify-content:space-between;margin:6px 0 10px}
.page-head.compact{padding:0}
.refresh-btn{border:1px solid #e6e9ed}

/* Chips & filter hàng 2 */
.btn-chip{border:1px solid #e5e7eb;background:#fff;border-radius:999px;padding:.25rem .6rem;font-size:.85rem}
.btn-chip .dot{display:inline-block;width:.5rem;height:.5rem;border-radius:50%;margin-right:.4rem}
.btn-chip.active{background:#eef2ff;border-color:#c7d2fe}

/* Table giống trang địa bàn */
.table thead th{background:#fafbfc;font-size:.78rem;color:#6b7280;font-weight:600}
.btn-group .btn + .btn { margin-left: 4px; }

/* Pagination */
.pagination .page-link{min-width:32px;text-align:center}

/* Badges */
.badge{font-weight:600;border-radius:999px;padding:.35rem .6rem}
.badge-soft-violet{background:#f3e8ff;color:#6d28d9}
.badge-soft-blue{background:#eff6ff;color:#2563eb}
.badge-soft-amber{background:#fffbeb;color:#b45309}
.badge-soft-green{background:#ecfdf5;color:#10b981}
.badge-soft-muted{background:#f3f4f6;color:#374151}

/* Overlay */
.x_content { position: relative; }
.dt-processing-overlay{
  position: absolute; inset: 0;
  display:flex; align-items:center; justify-content:center;
  background: rgba(255,255,255,.6); z-index: 10;
}
.dt-processing-box{
  padding: 10px 16px; border-radius: 8px; background: #ffffff; color: #28a745; font-weight: 600;
  border: 2px solid #28a745; box-shadow: 0 6px 20px rgba(0,0,0,.2);
}

/* Modal */
.x-modal{ position: fixed; inset: 0; z-index: 3000; display: grid; place-items: center; }
.x-modal__backdrop{ position:absolute; inset:0; background:rgba(0,0,0,.45); }
.x-modal__dialog{
  position: relative; width: min(900px, calc(100vw - 32px)); max-height: calc(100vh - 32px);
  background: #fff; border-radius: 8px; box-shadow: 0 12px 40px rgba(0,0,0,.35);
  display:flex; flex-direction:column; overflow:hidden;
}
.x-modal__dialog--danger{ border-top: 6px solid #ef4444; }
.x-modal__header, .x-modal__footer{ padding:12px 16px; display:flex; align-items:center; justify-content:space-between; }
.x-modal__header{ color:#fff; }
.x-modal__header--primary{ background:#0d6efd; }
.x-modal__header--warning{ background:#f59e0b; }
.x-modal__header--danger{ background:#ef4444; }
.x-modal__footer{ background:#f8fafc; border-top:1px solid #eef0f2; }
.x-modal__body{ padding:14px 16px; overflow:auto; }

.section-title{ font-weight:700; margin:2px 0 8px; }
.table-detail th{ width: 220px; background:#f8fafc; font-weight:700; }
.table-detail td, .table-detail th{ vertical-align: top; }
.prewrap{ white-space:pre-wrap; }
</style>
