<template>
  <div>
    <div class="page-title">
      <div class="title_left"><h3>Quản lý lỗ hổng bảo mật</h3></div>
      <div class="title_right">
        <div class="col-md-5 form-group pull-right top_search">
          <div class="input-group">
            <input
              v-model="search"
              type="text"
              class="form-control"
              placeholder="Tìm kiếm (CVE, tiêu đề, mô tả, CWE)"
              @input="applySearchDebounced"
              @keyup.enter="reload()"
            />
            <span class="input-group-btn">
              <button class="btn btn-secondary" @click="reload()">Tìm</button>
            </span>
          </div>
        </div>
      </div>
    </div>

    <div class="clearfix"></div>

    <div class="row">
      <div class="col-md-12 col-sm-12">
        <div class="x_panel">
          <div class="x_title">
            <h2>Dữ liệu <small>lỗ hổng bảo mật</small></h2>
            <ul class="nav navbar-right panel_toolbox">
              <li><a class="collapse-link"><i class="fa fa-chevron-up"></i></a></li>
              <li><a class="close-link"><i class="fa fa-close"></i></a></li>
            </ul>
            <div class="clearfix"></div>
          </div>

          <!-- Nút + BỘ LỌC -->
          <div class="d-flex align-items-center mb-3 flex-wrap form-inline">
            <button class="btn btn-success mr-2 mb-2" @click="showCreateModal = true">
              Thêm lỗ hổng bảo mật
            </button>

            <select
              class="form-control mr-2 mb-2"
              style="min-width:180px"
              v-model="filters.severity"
              @change="goToPage(1)"
            >
              <option value="">Mức độ (tất cả)</option>
              <option v-for="s in severityOptions" :key="s" :value="s">{{ sevLabel(s) }}</option>
            </select>

            <select
              class="form-control mr-2 mb-2"
              style="min-width:180px"
              v-model="filters.status"
              @change="goToPage(1)"
            >
              <option value="">Trạng thái (tất cả)</option>
              <option v-for="st in statusOptions" :key="st" :value="st">{{ st }}</option>
            </select>

            <button class="btn btn-outline-secondary mb-2" @click="resetFilters">Xóa lọc</button>
          </div>

          <div class="x_content position-relative">
            <!-- Thanh công cụ đồng bộ kiểu DataTables -->
            <div class="row mb-3" v-if="!loading">
              <div class="col-md-3">
                <label class="mr-2">Xem</label>
                <select class="form-control d-inline-block" style="width:auto" v-model.number="length" @change="goToPage(1)">
                  <option :value="10">10</option>
                  <option :value="25">25</option>
                  <option :value="50">50</option>
                  <option :value="100">100</option>
                </select>
                <span class="ml-2">mục</span>
              </div>

              <div class="col-md-6 text-center">
                <div class="btn-group">
                  <button class="btn btn-sm btn-secondary" @click="exportCopy">Copy</button>
                  <button class="btn btn-sm btn-success"   @click="exportExcel">Excel</button>
                  <button class="btn btn-sm btn-info"      @click="exportCSV">CSV</button>
                  <button class="btn btn-sm btn-danger"    @click="exportPDF">PDF</button>
                  <button class="btn btn-sm btn-dark"      @click="window.print()">Print</button>
                </div>
              </div>

              <div class="col-md-3">
                <div class="input-group">
                  <input
                    v-model="search"
                    type="text"
                    class="form-control"
                    placeholder="Tìm"
                    @input="applySearchDebounced"
                    @keyup.enter="reload()"
                  />
                  <span class="input-group-btn">
                    <button class="btn btn-secondary" @click="reload()">Tìm</button>
                  </span>
                </div>
              </div>
            </div>

            <!-- Overlay “Đang xử lý…” -->
            <div v-if="loading" class="dt-processing-overlay">
              <div class="dt-processing-box">Đang xử lý...</div>
            </div>

            <div v-if="loadError" class="text-danger mb-2">{{ loadError }}</div>

            <div class="table-responsive">
              <table class="table table-striped table-bordered" style="width:100%">
                <thead>
                  <tr>
                    <th style="width:70px">STT</th>
                    <th style="width:150px">Tên CVE</th>
                    <th>Tiêu đề</th>
                    <th style="width:150px">Mức độ</th>
                    <th style="width:110px">Điểm CVSS</th>
                    <th style="width:170px">Trạng thái</th>
                    <th style="width:160px">Hành động</th>
                  </tr>
                </thead>
                <tbody>
                  <tr v-if="items.length === 0 && !loading">
                    <td colspan="7" class="text-center text-muted">Không có dữ liệu</td>
                  </tr>
                  <tr v-for="(v, idx) in items" :key="v.id">
                    <td>{{ startIndex + idx + 1 }}</td>
                    <td>{{ v.cve_id || '—' }}</td>
                    <td>
                      <div class="font-weight-bold">{{ v.title }}</div>
                      <div class="small text-muted" v-if="v.cwe_id">CWE: {{ v.cwe_id }}</div>
                    </td>
                    <td><span :class="['badge', sevClass(v.severity)]">{{ sevLabel(v.severity) }}</span></td>
                    <td>{{ v.cvss_score ?? '—' }}</td>
                    <td><span :class="['badge', statusClass(v.status)]">{{ v.status || '—' }}</span></td>
                    <td>
                      <div class="btn-group" role="group">
                        <button class="btn btn-info btn-sm" title="Xem" @click="onView(v.id)">
                          <i class="fa fa-eye"></i>
                        </button>
                        <button class="btn btn-warning btn-sm" title="Sửa" @click="onEdit(v.id)">
                          <i class="fa fa-pencil"></i>
                        </button>
                        <button class="btn btn-danger btn-sm" title="Xóa" @click="onAskDelete(v.id)">
                          <i class="fa fa-trash"></i>
                        </button>
                      </div>
                    </td>
                  </tr>
                </tbody>
              </table>
            </div>

            <!-- Info + chọn số dòng/trang (hiển thị gọn) -->
            <div class="d-flex justify-content-between align-items-center flex-wrap">
              <div class="mb-2 text-muted" v-if="totalFiltered && !loading">
                Đang xem {{ items.length ? (startIndex + 1) : 0 }}–{{ Math.min(totalFiltered, startIndex + items.length) }} trong tổng số {{ totalFiltered }} mục
              </div>
            </div>

            <!-- Phân trang -->
            <nav v-if="totalPages > 1 && !loading" aria-label="Pagination">
              <ul class="pagination justify-content-end flex-wrap">
                <li class="page-item" :class="{ disabled: page === 1 }">
                  <button class="page-link" @click="goToPage(page - 1)" :disabled="page === 1">«</button>
                </li>
                <li
                  v-for="p in pageNumbers"
                  :key="p.key"
                  class="page-item"
                  :class="{ active: p.num === page, disabled: p.sep }"
                >
                  <button class="page-link" v-if="!p.sep" @click="goToPage(p.num)">{{ p.num }}</button>
                  <span class="page-link" v-else>…</span>
                </li>
                <li class="page-item" :class="{ disabled: page === totalPages }">
                  <button class="page-link" @click="goToPage(page + 1)" :disabled="page === totalPages">»</button>
                </li>
              </ul>
            </nav>

            <!-- Debug (ẩn mặc định) -->
            <div v-if="showDebug" class="card mt-3">
              <div class="card-body p-2">
                <div class="small text-muted">Debug:</div>
                <div class="small"><b>URL:</b> {{ lastFetch.url }}</div>
                <div class="small"><b>Status:</b> {{ lastFetch.status }}</div>
                <pre class="small m-0" style="white-space:pre-wrap">{{ lastFetch.snippet }}</pre>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Modals -->
    <VulnerabilityCreate
      v-if="showCreateModal"
      :showModal="showCreateModal"
      @submit="createItem"
      @close-modal="showCreateModal=false"
    />
    <VulnerabilityUpdate
      v-if="showEditModal"
      :showModal="showEditModal"
      :id="editingId"
      @emit-update="onUpdateSubmit"
      @close-modal="showEditModal=false"
    />
    <VulnerabilityDetail
      :showModal="showDetailModal"
      :vulnerabilityData="selectedVulnerability"
      @close="showDetailModal = false"
    />
    <VulnerabilityDeleteConfirm
      v-if="showDeleteConfirmModal && selectedVulnerability"
      :vulnerabilityData="selectedVulnerability"
      :showModal="showDeleteConfirmModal"
      @confirm-delete="deleteItemConfirm"
      @close-modal="showDeleteConfirmModal=false"
    />
  </div>
</template>

<script setup>
import { ref, computed, onMounted, watch } from 'vue'
import { useToast } from 'vue-toastification'
import { useVulnerability } from '@/composables/useVulnerability'

import VulnerabilityCreate from './VulnerabilityFormCreate.vue'
import VulnerabilityUpdate from './VulnerabilityFormUpdate.vue'
import VulnerabilityDetail from './VulnerabilityDetail.vue'
import VulnerabilityDeleteConfirm from './VulnerabilityDeleteConfirm.vue'

const toast = useToast()
const search = ref('')

const {
  selectedVulnerability,
  getVulnerabilityById,
  createVulnerabilityApi,
  updateVulnerabilityApi,
  deleteVulnerabilityApi
} = useVulnerability()

/* UI state */
const showCreateModal = ref(false)
const showEditModal = ref(false)
const showDetailModal = ref(false)
const showDeleteConfirmModal = ref(false)
const editingId = ref(null)

/* Data + phân trang */
const items = ref([])
const allRows = ref([])
const loading = ref(false)
const loadError = ref('')

const page = ref(1)
const length = ref(10)
const startIndex = computed(() => (page.value - 1) * length.value)

const draw = ref(1)
const totalFiltered = ref(0)
const serverTotal = ref(0)

/* filters */
const filters = ref({ severity: '', status: '' })
const severityOptions = ref(['Low', 'Medium', 'High', 'Critical'])
const statusOptions = ref(['Open','Under Investigation','Mitigated','Closed','Patched'])

/* debug */
const showDebug = ref(false)
const lastFetch = ref({ url: '', status: '', snippet: '' })

/* search debounce */
const searchDebounced = ref('')
let _timer = null
const norm = (s) =>
  String(s ?? '')
    .toLowerCase()
    .normalize('NFD').replace(/[\u0300-\u036f]/g, '')
    .replace(/\s+/g, ' ')
    .trim()
const applySearchDebounced = () => {
  clearTimeout(_timer)
  _timer = setTimeout(() => { searchDebounced.value = search.value; goToPage(1) }, 250)
}

const hasClientFilter = computed(() =>
  !!filters.value.severity || !!filters.value.status || !!norm(searchDebounced.value)
)

/* LOAD */
const load = async () => {
  if (hasClientFilter.value) await loadAllThenFilter()
  else await loadServerPage()
}

const loadServerPage = async () => {
  loading.value = true
  loadError.value = ''
  try {
    const params = new URLSearchParams()
    params.set('draw', String(draw.value))
    params.set('start', String(startIndex.value))
    params.set('length', String(length.value))

    const url = '/api/vulnerability?' + params.toString()
    const token = localStorage.getItem('token') || ''
    const headers = new Headers({ Accept: 'application/json' })
    if (token) headers.set('Authorization', 'Bearer ' + token)

    const res = await fetch(url, { headers, credentials: 'include' })
    const status = `${res.status} ${res.statusText}`
    const text = await res.text()
    lastFetch.value = { url, status, snippet: (text || '').slice(0, 800) }
    if (!res.ok) throw new Error(status)

    const json = JSON.parse(text || '{}')
    const rows = Array.isArray(json?.data) ? json.data : []
    serverTotal.value = Number(json?.recordsTotal ?? rows.length) || 0
    totalFiltered.value = Number(json?.recordsFiltered ?? rows.length) || 0

    items.value = rows.map(mapRow)
  } catch (e) {
    console.error(e)
    loadError.value = 'Không thể tải dữ liệu.'
    items.value = []
    totalFiltered.value = 0
  } finally {
    loading.value = false
    draw.value += 1
  }
}

const loadAllThenFilter = async () => {
  loading.value = true
  loadError.value = ''
  try {
    const params = new URLSearchParams()
    params.set('draw', String(draw.value))
    params.set('start', '0')
    params.set('length', '10000')

    const url = '/api/vulnerability?' + params.toString()
    const token = localStorage.getItem('token') || ''
    const headers = new Headers({ Accept: 'application/json' })
    if (token) headers.set('Authorization', 'Bearer ' + token)

    const res = await fetch(url, { headers, credentials: 'include' })
    const status = `${res.status} ${res.statusText}`
    const text = await res.text()
    lastFetch.value = { url, status, snippet: (text || '').slice(0, 800) }
    if (!res.ok) throw new Error(status)

    const json = JSON.parse(text || '{}')
    const rows = Array.isArray(json?.data) ? json.data : []
    serverTotal.value = Number(json?.recordsTotal ?? rows.length) || 0

    allRows.value = rows.map(mapRow)

    const kw = norm(searchDebounced.value)
    const filtered = allRows.value.filter(r => {
      if (filters.value.severity && r.severity !== filters.value.severity) return false
      if (filters.value.status   && r.status   !== filters.value.status)   return false
      if (kw) {
        const hay = norm([r.cve_id, r.title, r.description, r.cwe_id].join(' '))
        if (!hay.includes(kw)) return false
      }
      return true
    })

    totalFiltered.value = filtered.length
    const from = startIndex.value
    const to = from + length.value
    items.value = filtered.slice(from, to)
  } catch (e) {
    console.error(e)
    loadError.value = 'Không thể tải dữ liệu.'
    items.value = []
    totalFiltered.value = 0
  } finally {
    loading.value = false
    draw.value += 1
  }
}

const mapRow = (r, i) => ({
  id: r.id ?? i,
  cve_id: r.cve_id ?? null,
  title: r.title ?? '',
  description: r.description ?? '',
  severity: r.severity ?? '',
  cvss_score: r.cvss_score ?? null,
  cvss_vector: r.cvss_vector ?? null,
  cwe_id: r.cwe_id ?? null,
  affected_products: parseJsonList(r.affected_products),
  exploit_available: !!r.exploit_available,
  exploit_details: r.exploit_details ?? null,
  published_date: r.published_date ?? null,
  discovered_date: r.discovered_date ?? null,
  patched_date: r.patched_date ?? null,
  status: r.status ?? '',
  references: parseJsonList(r.references),
  reporter: r.reporter ?? null,
  created_at: r.created_at ?? null,
  updated_at: r.updated_at ?? null
})

const totalPages = computed(() => Math.max(1, Math.ceil(totalFiltered.value / length.value)))
const pageNumbers = computed(() => {
  const cur = page.value, last = totalPages.value, win = 2, out=[]
  const push = n => out.push({ key:'p'+n, num:n }), sep = k => out.push({ key:k, sep:true })
  if (last <= 7) { for (let i=1;i<=last;i++) push(i); return out }
  push(1); if (cur > 3 + win) sep('a')
  for (let i=Math.max(2, cur-win); i<=Math.min(last-1, cur+win); i++) push(i)
  if (cur < last - (2+win)) sep('b'); push(last); return out
})
const goToPage = (p) => {
  if (p < 1) p = 1
  if (p > totalPages.value) p = totalPages.value
  page.value = p
  load()
}
const reload = () => { page.value = 1; load() }

/* CRUD */
const onView = async (id) => { await getVulnerabilityById(id); showDetailModal.value = true }
const onEdit = (id) => { editingId.value = id; showEditModal.value = true }
const onAskDelete = async (id) => { await getVulnerabilityById(id); showDeleteConfirmModal.value = true }

const createItem = async (payload) => {
  try {
    await createVulnerabilityApi(payload)
    toast.success('Tạo lỗ hổng thành công!')
    showCreateModal.value = false
    reload()
  } catch (e) { console.error(e); alert('Tạo lỗ hổng thất bại!') }
}

// nhận từ modal: { id, payload }
const onUpdateSubmit = async ({ id, payload }) => {
  try {
    await updateVulnerabilityApi(id, payload)
    toast.success('Cập nhật thành công!')
    showEditModal.value = false
    reload()
  } catch (e) {
    if (e.response?.status === 422) {
      const msgs = Object.values(e.response.data.errors).flat().join('\n')
      alert('Cập nhật thất bại:\n' + msgs)
    } else {
      alert('Cập nhật thất bại!')
    }
  }
}

const deleteItemConfirm = async () => {
  try {
    if (!selectedVulnerability.value?.id) return alert('Không tìm thấy lỗ hổng để xóa.')
    await deleteVulnerabilityApi(selectedVulnerability.value.id)
    toast.warning('Xóa thành công!')
    showDeleteConfirmModal.value = false
    reload()
  } catch (e) { console.error(e); alert('Xóa thất bại!') }
}

/* helpers */
const sevLabel = (s) => {
  const key = String(s || '').toLowerCase()
  return ({ low:'Thấp', medium:'Trung bình', high:'Cao', critical:'Nghiêm trọng' }[key]) || (s || '—')
}
const sevClass = (s) => {
  const key = String(s || '').toLowerCase()
  return ({ low:'badge-success', medium:'badge-info', high:'badge-warning', critical:'badge-danger' }[key]) || 'badge-secondary'
}
const statusClass = (st) => {
  const k = String(st || '').toLowerCase()
  if (/open/.test(k)) return 'badge-warning'
  if (/closed/.test(k)) return 'badge-secondary'
  if (/under/.test(k)) return 'badge-info'
  if (/mitigated/.test(k)) return 'badge-primary'
  if (/patched/.test(k)) return 'badge-success'
  return 'badge-light'
}
function parseJsonList(raw) {
  if (!raw) return []
  if (Array.isArray(raw)) return raw
  if (typeof raw === 'string') {
    try { const j = JSON.parse(raw); return Array.isArray(j) ? j : [] } catch { return [] }
  }
  return []
}
const resetFilters = () => {
  filters.value = { severity:'', status:'' }
  search.value = ''
  searchDebounced.value = ''
  goToPage(1)
}

/* Export helpers */
const vulHeaders = ['STT','CVE','Tiêu đề','Mức độ','CVSS','Trạng thái']
const vulRows = () => items.value.map((v,i)=>[
  startIndex.value + i + 1,
  v.cve_id || '—',
  v.title,
  sevLabel(v.severity),
  v.cvss_score ?? '—',
  v.status || '—'
])
const exportCopy = () => {
  const lines = [vulHeaders.join('\t'), ...vulRows().map(r=>r.join('\t'))].join('\n')
  navigator.clipboard.writeText(lines); toast.success('Đã copy vào clipboard!')
}
const exportCSV = () => {
  const toCsv = (a)=>a.map(r=>r.map(v=>`"${String(v).replaceAll('"','""')}"`).join(',')).join('\n')
  const csv = toCsv([vulHeaders, ...vulRows()])
  const blob = new Blob([csv], {type:'text/csv;charset=utf-8;'})
  const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='vulnerabilities.csv'; a.click(); URL.revokeObjectURL(a.href)
}
const exportExcel = () => exportCSV()
const exportPDF = () => window.print()

/* watchers */
watch(length, () => goToPage(1))
watch(filters, () => goToPage(1), { deep: true })

/* init */
onMounted(load)
</script>

<style scoped>
/* Overlay “Đang xử lý…” giống DataTables */
.x_content { position: relative; }
.dt-processing-overlay {
  position: absolute;
  inset: 0;
  display: flex;
  align-items: center;
  justify-content: center;
  background: rgba(255, 255, 255, 0.6);
  z-index: 10;
}
.dt-processing-box {
  padding: 10px 16px;
  border-radius: 8px;
  background: #ffffff;
  color: #28a745;
  font-weight: 600;
  border: 2px solid #28a745;
  box-shadow: 0 6px 20px rgba(0,0,0,0.2);
}

/* Nhóm nút hành động gọn đẹp */
.btn-group .btn + .btn { margin-left: 4px; }
</style>
