<template>
  <div>
    <div
      :class="['modal','fade','bs-example-modal-lg',{'show d-block': showModal}]"
      tabindex="-1"
      aria-labelledby="createVulnerabilityModalLabel"
      :aria-hidden="!showModal"
    >
      <div class="modal-dialog modal-lg">
        <div class="modal-content">
          <div class="modal-header alert-success">
            <h5 class="modal-title" id="createVulnerabilityModalLabel">Thêm lỗ hổng bảo mật</h5>
            <button type="button" class="btn-close" @click="closeModal" aria-label="Close">&times;</button>
          </div>

          <div class="modal-body">
            <form @submit.prevent="handleSubmit">
              <div class="row">
                <div class="col-md-4 mb-3">
                  <label class="form-label">CVE ID</label>
                  <input type="text" class="form-control" v-model="form.cve_id" placeholder="VD: CVE-2024-1234" />
                </div>
                <div class="col-md-8 mb-3">
                  <label class="form-label">Tiêu đề <span class="text-danger">*</span></label>
                  <input type="text" class="form-control" v-model="form.title" required />
                </div>

                <div class="col-md-12 mb-3">
                  <label class="form-label">Mô tả</label>
                  <textarea class="form-control" rows="2" v-model="form.description"></textarea>
                </div>

                <div class="col-md-4 mb-3">
                  <label class="form-label">Mức độ <span class="text-danger">*</span></label>
                  <select class="form-control" v-model="form.severity" required>
                    <option disabled value="">-- Chọn mức độ --</option>
                    <option v-for="s in severityOptions" :key="s" :value="s">{{ sevLabel(s) }}</option>
                  </select>
                </div>

                <div class="col-md-4 mb-3">
                  <label class="form-label">CVSS Score</label>
                  <input type="number" step="0.1" min="0" max="10" class="form-control" v-model="form.cvss_score" />
                </div>

                <div class="col-md-4 mb-3">
                  <label class="form-label">CVSS Vector</label>
                  <input type="text" class="form-control" v-model="form.cvss_vector" placeholder="VD: AV:N/AC:L/PR:N/UI:N/..." />
                </div>

                <div class="col-md-4 mb-3">
                  <label class="form-label">CWE ID</label>
                  <input type="text" class="form-control" v-model="form.cwe_id" placeholder="VD: CWE-79" />
                </div>

                <div class="col-md-8 mb-3">
                  <label class="form-label">Sản phẩm ảnh hưởng</label>
                  <input
                    type="text"
                    class="form-control"
                    v-model="form.affected_products"
                    placeholder="Nhập danh sách, cách nhau bằng dấu phẩy (ví dụ: productA, productB)"
                  />
                </div>

                <div class="col-md-4 mb-3">
                  <label class="form-label d-block">Có khai thác?</label>
                  <div class="form-check mt-2">
                    <input id="expAvail" class="form-check-input" type="checkbox" v-model="form.exploit_available" />
                    <label for="expAvail" class="form-check-label">Exploit available</label>
                  </div>
                </div>

                <div class="col-md-8 mb-3">
                  <label class="form-label">Chi tiết khai thác</label>
                  <input type="text" class="form-control" v-model="form.exploit_details" />
                </div>

                <div class="col-md-4 mb-3">
                  <label class="form-label">Trạng thái</label>
                  <select class="form-control" v-model="form.status">
                    <option value="">-- Chọn trạng thái --</option>
                    <option v-for="st in statusOptions" :key="st" :value="st">{{ st }}</option>
                  </select>
                </div>

                <div class="col-md-4 mb-3">
                  <label class="form-label">Ngày công bố</label>
                  <input type="date" class="form-control" v-model="form.published_date" />
                </div>
                <div class="col-md-4 mb-3">
                  <label class="form-label">Ngày phát hiện</label>
                  <input type="date" class="form-control" v-model="form.discovered_date" />
                </div>
                <div class="col-md-4 mb-3">
                  <label class="form-label">Ngày vá</label>
                  <input type="date" class="form-control" v-model="form.patched_date" />
                </div>

                <div class="col-md-12 mb-3">
                  <label class="form-label">Tài liệu tham khảo</label>
                  <input
                    type="text"
                    class="form-control"
                    v-model="form.references"
                    placeholder="Nhập link, cách nhau bằng dấu phẩy"
                  />
                </div>

                <div class="col-md-6 mb-3">
                  <label class="form-label">Người báo cáo</label>
                  <input type="text" class="form-control" v-model="form.reporter" />
                </div>
              </div>

              <div class="modal-footer px-0 pb-0">
                <button type="button" class="btn btn-secondary" @click="closeModal">Hủy</button>
                <button type="submit" class="btn btn-primary">Thêm mới</button>
              </div>
                    <div class="col-md-12 mb-3">
  <label class="form-label">Nhập dữ liệu từ JSON</label>
  <input type="file" accept=".json" @change="handleJsonImport" class="form-control" />
</div>
            </form>
     
          </div>

        </div>
      </div>
    </div>
    <div v-if="showModal" class="modal-backdrop fade show"></div>
   

  </div>
</template>

<script setup>
import { ref, watch, onMounted } from 'vue'

const props = defineProps({
  showModal: { type: Boolean, required: true }
})
const emit = defineEmits(['submit','close-modal'])

/** Options (value tiếng Anh để khớp backend) */
const severityOptions = ['Low', 'Medium', 'High', 'Critical']
const statusOptions   = ['Open', 'Under Investigation', 'Mitigated', 'Closed', 'Patched']

/** Form state */
const form = ref({
  cve_id: '',
  title: '',
  description: '',
  severity: '',
  cvss_score: '',
  cvss_vector: '',
  cwe_id: '',
  affected_products: '',    // user nhập text, khi submit sẽ chuyển thành JSON string
  exploit_available: false,
  exploit_details: '',
  published_date: '',
  discovered_date: '',
  patched_date: '',
  status: '',
  references: '',           // user nhập text, khi submit sẽ chuyển thành JSON string
  reporter: ''
})

onMounted(() => {
  if (props.showModal) document.body.classList.add('modal-open')
})
watch(() => props.showModal, (visible) => {
  if (visible) {
    resetForm()
    document.body.classList.add('modal-open')
  } else {
    document.body.classList.remove('modal-open')
  }
})

/** Helpers */
const sevLabel = (s) => {
  const k = String(s || '').toLowerCase()
  return ({low:'Thấp',medium:'Trung bình',high:'Cao',critical:'Nghiêm trọng'}[k]) || s || ''
}

function resetForm() {
  form.value = {
    cve_id: '',
    title: '',
    description: '',
    severity: '',
    cvss_score: '',
    cvss_vector: '',
    cwe_id: '',
    affected_products: '',
    exploit_available: false,
    exploit_details: '',
    published_date: '',
    discovered_date: '',
    patched_date: '',
    status: '',
    references: '',
    reporter: ''
  }
}
function splitList(val) {
  if (!val) return []
  return val.split(',').map(s => s.trim()).filter(Boolean)
}
function toDateTime(val) {
  // input type="date" -> 'YYYY-MM-DD 00:00:00' | null
  if (!val) return null
  const d = String(val).trim()
  return d ? `${d} 00:00:00` : null
}
function toNull(s) {
  const v = (s ?? '').toString().trim()
  return v === '' ? null : v
}

/** Submit -> chuẩn hóa payload đúng API backend */
function handleSubmit() {
  if (!form.value.title.trim()) {
    alert('Vui lòng nhập Tiêu đề.')
    return
  }
  if (!form.value.severity) {
    alert('Vui lòng chọn Mức độ.')
    return
  }

  const affected = splitList(form.value.affected_products)
  const refs     = splitList(form.value.references)

  const payload = {
    cve_id: toNull(form.value.cve_id),
    title: form.value.title.trim(),
    description: toNull(form.value.description),
    severity: form.value.severity,
    cvss_score: form.value.cvss_score === '' ? null : String(form.value.cvss_score),
    cvss_vector: toNull(form.value.cvss_vector),
    cwe_id: toNull(form.value.cwe_id),

    // Backend của bạn đang lưu dạng CHUỖI JSON -> gửi dạng string
    affected_products: affected.length ? JSON.stringify(affected) : null,
    references: refs.length ? JSON.stringify(refs) : null,

    exploit_available: !!form.value.exploit_available,
    exploit_details: toNull(form.value.exploit_details),

    // Ngày dạng 'YYYY-MM-DD 00:00:00'
    published_date: toDateTime(form.value.published_date),
    discovered_date: toDateTime(form.value.discovered_date),
    patched_date: toDateTime(form.value.patched_date),

    status: toNull(form.value.status),
    reporter: toNull(form.value.reporter)
  }
  function handleJsonImport(event) {
  const file = event.target.files[0]
  if (!file) return

  const reader = new FileReader()
  reader.onload = (e) => {
    try {
      const data = JSON.parse(e.target.result)

      // Map giá trị nếu tồn tại, giữ nguyên form cũ nếu không có
      form.value = {
        cve_id: data.cve_id || '',
        title: data.title || '',
        description: data.description || '',
        severity: data.severity || '',
        cvss_score: data.cvss_score || '',
        cvss_vector: data.cvss_vector || '',
        cwe_id: data.cwe_id || '',
        affected_products: Array.isArray(data.affected_products) ? data.affected_products.join(', ') : '',
        exploit_available: !!data.exploit_available,
        exploit_details: data.exploit_details || '',
        published_date: data.published_date ? data.published_date.split(' ')[0] : '',
        discovered_date: data.discovered_date ? data.discovered_date.split(' ')[0] : '',
        patched_date: data.patched_date ? data.patched_date.split(' ')[0] : '',
        status: data.status || '',
        references: Array.isArray(data.references) ? data.references.join(', ') : '',
        reporter: data.reporter || ''
      }

      alert('Đã nhập dữ liệu từ file JSON!')
    } catch (error) {
      alert('File JSON không hợp lệ!')
    }
  }
  reader.readAsText(file)
}

  emit('submit', payload)
}

function closeModal() {
  emit('close-modal')
}
</script>
