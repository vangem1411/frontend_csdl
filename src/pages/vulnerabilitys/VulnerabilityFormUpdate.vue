<template>
  <div>
    <div
      :class="['modal','fade','bs-example-modal-lg', { show: showModal, 'd-block': showModal }]"
      tabindex="-1"
      aria-labelledby="updateVulnerabilityModalLabel"
      :aria-hidden="!showModal"
    >
      <div class="modal-dialog modal-lg">
        <div class="modal-content">
          <div class="modal-header alert-warning">
            <h5 class="modal-title" id="updateVulnerabilityModalLabel">Cập nhật lỗ hổng bảo mật</h5>
            <button type="button" class="btn-close" @click="closeModal" aria-label="Close">&times;</button>
          </div>

          <div class="modal-body">
            <div v-if="loadingData" class="alert alert-info py-2 mb-3">Đang tải dữ liệu…</div>
            <div v-if="errorMsg" class="alert alert-danger py-2">{{ errorMsg }}</div>

            <form v-if="!loadingData" @submit.prevent="handleSubmit">
              <div class="row">
                <div class="col-md-4 mb-3">
                  <label class="form-label">CVE ID</label>
                  <input type="text" class="form-control" v-model="form.cve_id" placeholder="VD: CVE-2024-1234" />
                </div>
                <div class="col-md-8 mb-3">
                  <label class="form-label">Tiêu đề <span class="text-danger">*</span></label>
                  <input type="text" class="form-control" v-model="form.title" required />
                </div>

                <div class="col-md-12 mb-3">
                  <label class="form-label">Mô tả</label>
                  <textarea class="form-control" rows="2" v-model="form.description"></textarea>
                </div>

                <div class="col-md-4 mb-3">
                  <label class="form-label">Mức độ <span class="text-danger">*</span></label>
                  <select class="form-control" v-model="form.severity" required>
                    <option disabled value="">-- Chọn mức độ --</option>
                    <option v-for="s in severityOptions" :key="s" :value="s">{{ sevLabel(s) }}</option>
                  </select>
                </div>

                <div class="col-md-4 mb-3">
                  <label class="form-label">CVSS Score</label>
                  <input type="number" step="0.1" min="0" max="10" class="form-control" v-model="form.cvss_score" />
                </div>

                <div class="col-md-4 mb-3">
                  <label class="form-label">CVSS Vector</label>
                  <input type="text" class="form-control" v-model="form.cvss_vector" placeholder="VD: AV:N/AC:L/PR:N/UI:N/..." />
                </div>

                <div class="col-md-4 mb-3">
                  <label class="form-label">CWE ID</label>
                  <input type="text" class="form-control" v-model="form.cwe_id" placeholder="VD: CWE-79" />
                </div>

                <div class="col-md-8 mb-3">
                  <label class="form-label">Sản phẩm ảnh hưởng</label>
                  <input
                    type="text"
                    class="form-control"
                    v-model="form.affected_products"
                    placeholder="Danh sách, cách nhau bằng dấu phẩy"
                  />
                </div>

                <div class="col-md-4 mb-3">
                  <label class="form-label d-block">Có khai thác?</label>
                  <div class="form-check mt-2">
                    <input id="expAvailUpd" class="form-check-input" type="checkbox" v-model="form.exploit_available" />
                    <label for="expAvailUpd" class="form-check-label">Exploit available</label>
                  </div>
                </div>

                <div class="col-md-8 mb-3">
                  <label class="form-label">Chi tiết khai thác</label>
                  <input type="text" class="form-control" v-model="form.exploit_details" />
                </div>

                <div class="col-md-4 mb-3">
                  <label class="form-label">Trạng thái</label>
                  <select class="form-control" v-model="form.status">
                    <option value="">-- Chọn trạng thái --</option>
                    <option v-for="st in statusOptions" :key="st" :value="st">{{ st }}</option>
                  </select>
                </div>

                <div class="col-md-4 mb-3">
                  <label class="form-label">Ngày công bố</label>
                  <input type="date" class="form-control" v-model="form.published_date" />
                </div>
                <div class="col-md-4 mb-3">
                  <label class="form-label">Ngày phát hiện</label>
                  <input type="date" class="form-control" v-model="form.discovered_date" />
                </div>
                <div class="col-md-4 mb-3">
                  <label class="form-label">Ngày vá</label>
                  <input type="date" class="form-control" v-model="form.patched_date" />
                </div>

                <div class="col-md-12 mb-3">
                  <label class="form-label">Tài liệu tham khảo</label>
                  <input
                    type="text"
                    class="form-control"
                    v-model="form.references"
                    placeholder="Link, cách nhau bằng dấu phẩy"
                  />
                </div>

                <div class="col-md-6 mb-3">
                  <label class="form-label">Người báo cáo</label>
                  <input type="text" class="form-control" v-model="form.reporter" />
                </div>
              </div>

              <div class="modal-footer px-0 pb-0">
                <button type="button" class="btn btn-secondary" @click="closeModal" :disabled="saving || loadingData">Hủy</button>
                <button type="submit" class="btn btn-warning" :disabled="saving || loadingData">
                  <span v-if="saving" class="spinner-border spinner-border-sm mr-1"></span>
                  Lưu thay đổi
                </button>
              </div>
            </form>
          </div>

        </div>
      </div>
    </div>
    <!-- Backdrop thủ công -->
    <div v-if="showModal" class="modal-backdrop fade show"></div>
  </div>
</template>

<script setup>
import { ref, watch, onMounted, onUnmounted, nextTick } from 'vue'
import { useVulnerability } from '@/composables/useVulnerability'

const props = defineProps({
  showModal: { type: Boolean, required: true },
  // Truyền 1 trong 2: id (để modal tự fetch) hoặc object đã có sẵn
  id: { type: [Number, String], default: null },
  vulnerabilityData: { type: Object, default: null }
})
const emit = defineEmits(['emit-update','close-modal'])

const { getVulnerabilityById } = useVulnerability()

/* Options */
const severityOptions = ['Low', 'Medium', 'High', 'Critical']
const statusOptions   = ['Open', 'Under Investigation', 'Mitigated', 'Closed', 'Patched']

/* Form state */
const form = ref({
  cve_id: '',
  title: '',
  description: '',
  severity: '',
  cvss_score: '',
  cvss_vector: '',
  cwe_id: '',
  affected_products: '',
  exploit_available: false,
  exploit_details: '',
  published_date: '',
  discovered_date: '',
  patched_date: '',
  status: '',
  references: '',
  reporter: ''
})

const saving = ref(false)
const loadingData = ref(false)
const errorMsg = ref('')

/* Helpers */
const sevLabel = (s) => {
  const k = String(s || '').toLowerCase()
  return ({low:'Thấp',medium:'Trung bình',high:'Cao',critical:'Nghiêm trọng'}[k]) || s || ''
}
function parseJsonListMaybe(strOrArr) {
  if (!strOrArr) return []
  if (Array.isArray(strOrArr)) return strOrArr
  if (typeof strOrArr === 'string') {
    try { const j = JSON.parse(strOrArr); return Array.isArray(j) ? j : [] } catch { return [] }
  }
  return []
}
function listToInput(list) { return (list || []).join(', ') }
function splitList(val) { return (val || '').split(',').map(s => s.trim()).filter(Boolean) }
function toInputDate(dt) { return dt ? String(dt).slice(0,10) : '' }
function toDateTime(val) { return val ? `${String(val).trim()} 00:00:00` : undefined }
function toValueOrSkip(v) {
  if (v === undefined || v === null) return undefined
  const s = v.toString().trim()
  return s === '' ? undefined : v
}

/* ===== Scroll/Backdrop safety ===== */
function unlockScroll() {
  const html = document.documentElement
  const body = document.body
  body.classList.remove('modal-open')
  html.classList.remove('modal-open')
  body.style.overflow = ''
  html.style.overflow = ''
  document.querySelectorAll('.modal-backdrop').forEach(el => el.remove())
}

/* Đổ dữ liệu */
async function fillFormFromData(d) {
  if (!d) return
  await nextTick()
  const affected = parseJsonListMaybe(d.affected_products)
  const refs     = parseJsonListMaybe(d.references)
  form.value = {
    cve_id: d.cve_id ?? '',
    title: d.title ?? '',
    description: d.description ?? '',
    severity: d.severity ?? '',
    cvss_score: d.cvss_score ?? '',
    cvss_vector: d.cvss_vector ?? '',
    cwe_id: d.cwe_id ?? '',
    affected_products: listToInput(affected),
    exploit_available: !!d.exploit_available,
    exploit_details: d.exploit_details ?? '',
    published_date: toInputDate(d.published_date),
    discovered_date: toInputDate(d.discovered_date),
    patched_date: toInputDate(d.patched_date),
    status: d.status ?? '',
    references: listToInput(refs),
    reporter: d.reporter ?? ''
  }
}

/* Tải chi tiết khi mở modal */
async function loadIfNeeded() {
  errorMsg.value = ''
  if (!props.showModal) return
  loadingData.value = true
  try {
    if (props.vulnerabilityData && props.vulnerabilityData.id) {
      await fillFormFromData(props.vulnerabilityData)
    } else if (props.id) {
      await getVulnerabilityById(props.id)
      const token = localStorage.getItem('token') || ''
      const res = await fetch(`/api/vulnerability/${props.id}`, {
        headers: { Accept: 'application/json', ...(token ? { Authorization: 'Bearer ' + token } : {}) }
      })
      const detail = await res.json()
      await fillFormFromData(detail || {})
    } else {
      console.warn('[UpdateModal] Không có id/vulnerabilityData để load.')
    }
  } catch (e) {
    console.error(e)
    errorMsg.value = 'Không thể tải dữ liệu.'
  } finally {
    loadingData.value = false
  }
}

/* lifecycle + watchers */
onMounted(() => {
  if (props.showModal) {
    document.body.classList.add('modal-open')
    loadIfNeeded()
  }
})

watch(() => props.showModal, (v) => {
  if (v) {
    document.body.classList.add('modal-open')
    loadIfNeeded()
  } else {
    // Khi đóng: luôn gỡ khóa cuộn + backdrop
    nextTick(unlockScroll)
  }
})

watch(() => props.vulnerabilityData, (val) => {
  if (props.showModal && val) fillFormFromData(val)
}, { deep: true })

onUnmounted(() => {
  // Nếu component bị unmount trong lúc đang mở, vẫn gỡ khóa
  unlockScroll()
})

/* Submit */
function handleSubmit() {
  errorMsg.value = ''
  if (!form.value.title.trim()) { errorMsg.value = 'Vui lòng nhập Tiêu đề.'; return }
  if (!form.value.severity)     { errorMsg.value = 'Vui lòng chọn Mức độ.'; return }

  const affected = splitList(form.value.affected_products)
  const refs     = splitList(form.value.references)

  const raw = {
    cve_id: toValueOrSkip(form.value.cve_id),
    title: toValueOrSkip(form.value.title.trim()),
    description: toValueOrSkip(form.value.description),
    severity: toValueOrSkip(form.value.severity),
    cvss_score: form.value.cvss_score === '' ? undefined : String(form.value.cvss_score),
    cvss_vector: toValueOrSkip(form.value.cvss_vector),
    cwe_id: toValueOrSkip(form.value.cwe_id),
    affected_products: affected.length ? JSON.stringify(affected) : undefined,
    references: refs.length ? JSON.stringify(refs) : undefined,
    exploit_available: form.value.exploit_available,
    exploit_details: toValueOrSkip(form.value.exploit_details),
    published_date: toDateTime(form.value.published_date),
    discovered_date: toDateTime(form.value.discovered_date),
    patched_date: toDateTime(form.value.patched_date),
    status: toValueOrSkip(form.value.status),
    reporter: toValueOrSkip(form.value.reporter)
  }
  const payload = {}
  Object.keys(raw).forEach(k => { if (raw[k] !== undefined) payload[k] = raw[k] })

  try {
    saving.value = true
    const id = props.vulnerabilityData?.id ?? props.id
    emit('emit-update', { id, payload })
  } finally {
    saving.value = false
  }
}

function closeModal() {
  errorMsg.value = ''
  emit('close-modal')
  nextTick(unlockScroll)
}
</script>
